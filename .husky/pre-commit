#!/bin/sh
# Exit on any error
set -e

# Check if there are any staged files
if [ -z "$(git diff --cached --name-only)" ]; then
  echo "No staged files to format"
  exit 0
fi

# Store the hash of staged changes to detect modifications
STAGED_HASH=$(git diff --cached | sha256sum | cut -d' ' -f1)

# Save list of staged files (handling all file states)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Run formatter on the staged files (formatter only touches staged files)
bun x ultracite fix
FORMAT_EXIT_CODE=$?

# Re-stage the formatted files using update-index to avoid index lock conflicts
# This is more efficient and less prone to locking issues on Windows
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      # Use update-index which is faster and less likely to conflict
      git update-index --add -- "$file" 2>/dev/null || git add "$file" 2>/dev/null || true
    fi
  done
fi

# Check if staged files actually changed
NEW_STAGED_HASH=$(git diff --cached | sha256sum | cut -d' ' -f1)
if [ "$STAGED_HASH" != "$NEW_STAGED_HASH" ]; then
  echo "âœ¨ Files formatted by Ultracite"
fi

exit $FORMAT_EXIT_CODE
