name: Publish to npm

on:
	push:
		branches:
			- main
		paths:
			- 'package.json'

jobs:
	publish:
		runs-on: ubuntu-latest
		permissions:
			contents: read
			id-token: write

		steps:
			- name: Checkout code
				uses: actions/checkout@v4

			- name: Setup Bun
				uses: oven-sh/setup-bun@v2
				with:
					bun-version: latest

			- name: Extract version
				id: version
				run: |
					VERSION=$(node -p "require('./package.json').version")
					echo "version=$VERSION" >> $GITHUB_OUTPUT
					echo "Current version: $VERSION"

			- name: Check if version exists on npm
				id: check-version
				run: |
					VERSION="${{ steps.version.outputs.version }}"
					PACKAGE_NAME=$(node -p "require('./package.json').name")
					
					if npm view "$PACKAGE_NAME@$VERSION" version > /dev/null 2>&1; then
						echo "exists=true" >> $GITHUB_OUTPUT
						echo "Version $VERSION already exists on npm, skipping publish"
					else
						echo "exists=false" >> $GITHUB_OUTPUT
						echo "Version $VERSION is new, will publish"
					fi

			- name: Configure npm
				if: steps.check-version.outputs.exists == 'false'
				run: |
					echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

			- name: Install dependencies
				if: steps.check-version.outputs.exists == 'false'
				run: bun install --frozen-lockfile

			- name: Publish to npm
				if: steps.check-version.outputs.exists == 'false'
				run: npm publish --access public
				env:
					NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

			- name: Create GitHub Release
				if: steps.check-version.outputs.exists == 'false'
				uses: actions/create-release@v1
				env:
					GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
				with:
					tag_name: v${{ steps.version.outputs.version }}
					release_name: Release v${{ steps.version.outputs.version }}
					draft: false
					prerelease: false

